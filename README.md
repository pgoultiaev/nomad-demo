## Docker scheduler and service discovery with Nomad+Consul_Consult_template+haproxy

This demo to quickly show you how to use nomad and consul setup a docker scheduler across cluster host as well as docker service discovery

#### Nomad & Consul single server setup 
3 VMs : Docker1 Docker2 Docker3

Docker1 :  Nomad & Consul server as well as client

Docker2 :  Nomad & Consul client 

Docker3 :  Nomad & Consul client

#### Nomad & Consul two servers setup 
2 VMs : Docker1 Docker2

Docker1 :  Nomad server/client + Consul server/client

Docker2 :  Nomad server/client + Consul server/client

#### Bootstrap
$ cd single_server_three_client
OR
$ cd two_servers
 
$ vagrant up


#### Fire up a Job
$ vagrant ssh docker1

vagrant@docker1:~$ cd /vagrant
vagrant@docker1:/vagrant$ nomad run loadbalancer.nomad
vagrant@docker1:/vagrant$ nomad run example.nomad


#### View nodes & service in consul 
http://192.168.0.20:8500

Get docker instance meta-data from consul 

$ curl http://192.168.0.20:8500/v1/catalog/service/cache-redis

* In two servers configuration you can use both servers to action above operations

#### Check job status from nomad client

vagrant@docker1:~$ nomad node-status

vagrant@docker1:~$ nomad status loadbalancer
vagrant@docker1:~$ nomad status example



#### Check Haproxy config generated by consul_template 
Go any of vm , like docker1 , docker 2

vagrant@docker1:~$ docker exec <haproxy_container_id> cat /haproxy/haproxy.cfg

vagrant@docker2:~$ docker exec <haproxy_container_id> cat /haproxy/haproxy.cfg

###### beer!


 